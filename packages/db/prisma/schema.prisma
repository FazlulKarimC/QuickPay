generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id                Int             @id @default(autoincrement())
  email             String?         @unique
  name              String?
  number            String          @unique
  password          String
  
  // Relations
  wallet            Wallet?
  paymentIntents    PaymentIntent[]
  sentTransfers     p2pTransfer[]   @relation(name: "FromUserRelation")
  receivedTransfers p2pTransfer[]   @relation(name: "ToUserRelation")
}

model Merchant {
  id             Int             @id @default(autoincrement())
  email          String?         @unique
  number         String          @unique  // Phone number for auth
  password       String                   // Hashed password
  name           String?
  auth_type      AuthType        @default(Google)
  apiKey         String          @unique @default(cuid())
  webhookUrl     String?
  
  // Relations
  paymentIntents PaymentIntent[]
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

// ==================== PAYMENT SYSTEM ====================

model PaymentIntent {
  id              String          @id @default(cuid())
  amount          Int             // Amount in smallest currency unit (paise)
  currency        String          @default("INR")
  status          PaymentStatus   @default(created)
  clientSecret    String          @unique @default(cuid())
  idempotencyKey  String?         @unique
  paymentMethod   PaymentMethod?
  metadata        Json?
  failureReason   String?
  bankReference   String?
  
  // Relations
  merchantId      Int
  merchant        Merchant        @relation(fields: [merchantId], references: [id])
  userId          Int?
  user            User?           @relation(fields: [userId], references: [id])
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  processedAt     DateTime?
  
  @@index([merchantId])
  @@index([userId])
  @@index([status])
}

// ==================== WALLET SYSTEM ====================

model Wallet {
  id           String              @id @default(cuid())
  userId       Int                 @unique
  user         User                @relation(fields: [userId], references: [id])
  balance      Int                 @default(0) // In paise (1 INR = 100 paise)
  
  transactions WalletTransaction[]
  
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
}

model WalletTransaction {
  id          String          @id @default(cuid())
  walletId    String
  wallet      Wallet          @relation(fields: [walletId], references: [id])
  type        TransactionType
  amount      Int             // In paise
  reference   String          // PaymentIntent ID or P2P transfer ID
  description String?
  
  createdAt   DateTime        @default(now())
  
  @@index([walletId])
}

// ==================== P2P TRANSFERS ====================

model p2pTransfer {
  id         Int      @id @default(autoincrement())
  amount     Int
  timestamp  DateTime
  fromUserId Int
  fromUser   User     @relation(name: "FromUserRelation", fields: [fromUserId], references: [id])
  toUserId   Int
  toUser     User     @relation(name: "ToUserRelation", fields: [toUserId], references: [id])
  
  @@index([fromUserId])
  @@index([toUserId])
}

// ==================== RATE LIMITING ====================

model RateLimitEntry {
  id          String   @id @default(cuid())
  key         String   // e.g., "api:merchant_id:123" or "ip:192.168.1.1"
  count       Int      @default(1)
  windowStart DateTime
  
  @@index([key, windowStart])
}

// ==================== ENUMS ====================

enum AuthType {
  Google
  Github
}

enum PaymentStatus {
  created       // Initial state
  processing    // Sent to bank
  succeeded     // Payment complete
  failed        // Payment failed
  canceled      // Canceled by user/merchant
  refunded      // Refunded after success
}

enum PaymentMethod {
  card
  upi
  netbanking
}

enum TransactionType {
  credit        // Money added (payment success, refund received)
  debit         // Money removed (refund issued, P2P sent)
  p2p_sent      // P2P transfer sent
  p2p_received  // P2P transfer received
}
